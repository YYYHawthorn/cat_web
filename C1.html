<!DOCTYPE html>
<html>

<head >
 
<title>Cat1</title>

 <meta charset=utf-8 />

 <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
 
    <script src="js/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.3/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reqwest/1.1.5/reqwest.min.js"></script>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css"/>
    <link type="text/css" rel="stylesheet" href="css/style.css"/>

<style type="text/css">

    body  {
        background-color:#F5A623; 
    }
 /*   .body{
        padding-top: 20px;
        width: 85%;
        z-index:1;
    }*/

    #playNext {
        position: relative;
        top: -880px;
        left: 80%;
        z-index:2;
    }
      #player {
        position: relative;
        left: 18%;
        margin:0 auto;
        top: -1450px;
        z-index: 3;
      }
      .word{
        position: relative;
        top: 150px;
      }
      #title{
        /* Help: */
        font-family: GothamExLight;
        font-size: 50px;
        color: #101010;
        line-height: 130%;
      }

</style>

</head>

<body>

    <div class="row">
        <div class="col-md-6" >
            <img src="pics/body.png" class="img-responsive center-block body" id="cbody" alt="Responsive image" >
            <div><img src="pics/paw.gif"  id="playNext" class="img-responsive" alt="Responsive image" ></div>
            <div id="player" ></div>
        </div>

        <div class="col-md-6 word">
            <p id="title">HELP BIG CATS PURR</p>
            <div id="count"></div>
        </div>

    </div>
   



<script type="text/javascript">
  
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      //randomize playlist
      var randomnumber = Math.floor(Math.random() * 11) ;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player'
          , {
          height: '450px',
          width: '600px',
          playerVars:{listType: 'playlist',
                    list:'PLW1bZqF7FVSN31ILibwTRdYinMq4mx8Vp',
                    controls:1,
                    autoplay:1,
                    index:randomnumber,
                    rel: 0,
                    // suggestedQuality:'hd720'
                  },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });        
      }
   


      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
        saveVideoInfo();

         var playNextBtn = document.getElementById('playNext'); 
         playNextBtn.onclick= function(){
           player.nextVideo();
         }
      }

      // 5. The API calls this function when the player's state changes.
      function onPlayerStateChange(event) {
        //when a video ends(state=0),the page will redirect to next page.

        if (event.data == YT.PlayerState.ENDED) {
          //redirect to C3
          window.location = "c3.html";
        }

        else if ( event.data == YT.PlayerState.UNSTARTED){
            saveVideoInfo();        
          }
      }
      
      function stopVideo() {
        player.stopVideo();
      }

      var videoInfo = [];
      function saveVideoInfo() {
        var videoUrl = player.getVideoUrl();
        var videoId = getParameterByKey(videoUrl, 'v');
        console.log('video id: '+videoId);

        addVideoData(videoId);


      }

      // parse the url to get the id of a video
      function getParameterByKey(url, name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec('?'+url.split('?')[1]);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      //get the title and view number of this video using Google API, and add them to the variable videoInfo
      function addVideoData(urlId){
        //TODO: get the data using API

        var key = 'AIzaSyDPUqAa8ZkqTuiYshHqI5L9BjX1WVOuQvk';
        var url = 'https://www.googleapis.com/youtube/v3/videos?id='+urlId+'&key='+key+'&fields=items(id,snippet(channelId,title,categoryId),statistics)&part=snippet,statistics';

        reqwest({
             url: url
           , type: 'json'
           , crossOrigin: true
           , success: function(data){
              var title = data.items[0].snippet.title;
              var view = data.items[0].statistics.viewCount;
              videoInfo.push({title:title, view:view});
              console.log(videoInfo);
              //save  the data, so you can get it later in c3.html
            localStorage.setItem("videoInfo", JSON.stringify(videoInfo));

            console.log(videoInfo);
            loadVideoInfo();

            }
        })
        // p5.loadJSON(url, function(data){
        //   alert('ssss');
        //   console.log(data);
        //     var view = 'put view number here, should be a number'
        //     var title = data.items[0].statistics.viewCount;
        //     videoInfo.push({title:title, view:view});

        // })

        //Google Data API requires a KEY
        //when you get the data, you sould save them into two variables
        // var title = 'put title here'
        // var view = 'put view number here, should be a number'
      }


      //redirect to next page when press enter key
      document.addEventListener("keydown", function(e) {
        if (e.keyCode == 13) { 
          window.location = "c3.html";
        };
      }, false);

    function loadVideoInfo(){

      var info = videoInfo[videoInfo.length-1];
      console.log(videoInfo);
      $('#count').append('<li>'+'Name: '+info.title+'</li>');
      $('#count').append('<li>'+'Views: '+'<b>'+info.view+'</b>'+'</li>'+ '</br>');

      return info;
    }

//************** shortcut to next page: enter *****************
window.onload=function() {
        //redirect to next page when press enter key
        document.addEventListener("keydown", function(e) {
          if (e.keyCode == 13) { 
            window.location = "c3.html";
          };
        }, false);
      }
</script>


</body>
</html>