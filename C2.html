<!DOCTYPE html>
<html>
  <head>
   <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="style.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/query.glow.js" type="text/javascript"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.3/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reqwest/1.1.5/reqwest.min.js"></script>

    <style type="text/css">
      body  {
        background-color: #F5A623;
      }
      #back {
      width: 850px;
/*      position: absolute;
      left: 150px;
      padding: 20px;*/
      z-index: -1;
    }
      #player {
      position: relative;
      left: 28%;
      top: -1320px;
      z-index: 1;
      }

      #playNext {
      width: 250px;
      position: relative;
      top: -1560px;
      left: 72%;
      z-index:2;
    }
      .next{
        z-index: 3;
        position: relative;
        left: 90%;
        font-size: 2em;
      }
    </style>
  </head>
  


<body>
  <div>
    <div id="click">
      <a href="c3.html" class="btn btn-danger btn-lg next">Next</a>
    </div>
    <div><img id="back" class="img-responsive center-block" src="pics/body.png"></div>
    <div id="player"></div>

    <div><img src="pics/paw.gif" id="playNext"  class="img-responsive"></div>

  </div>
  <div id="count">
  </div>
  

    <script>
 
$(document).ready(function(){ 
  $("#playNext").glow({ radius: "10", color:"green" });
  //Blink with time Interval (timegap)
  // $("#playNext").glow({ radius: "20", color:"blue", disable:true, blink:true, timegap:2000 }); 
});

      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      //randomize playlist
      var randomnumber = Math.floor(Math.random() * 11) ;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player'
          , {
          height: '450px',
          width: '600px',
          playerVars:{listType: 'playlist',
                    list:'PLW1bZqF7FVSN31ILibwTRdYinMq4mx8Vp',
                    controls:1,
                    autoplay:1,
                    index:randomnumber,
                    rel: 0,
                    // suggestedQuality:'hd720'
                  },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });        
      }
   


      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
        saveVideoInfo();

         var playNextBtn = document.getElementById('playNext'); 
         playNextBtn.onclick= function(){
           player.nextVideo();
         }
      }

      // 5. The API calls this function when the player's state changes.
      function onPlayerStateChange(event) {
        //when a video ends(state=0),the page will redirect to next page.

        if (event.data == YT.PlayerState.ENDED) {
          //redirect to C3
          window.location = "c3.html";
        }

        else if ( event.data == YT.PlayerState.UNSTARTED){
            saveVideoInfo();        
          }
      }
      
      function stopVideo() {
        player.stopVideo();
      }

      var videoInfo = [];
      function saveVideoInfo() {
        var videoUrl = player.getVideoUrl();
        var videoId = getParameterByKey(videoUrl, 'v');
        console.log('video id: '+videoId);

        addVideoData(videoId);


      }

      // parse the url to get the id of a video
      function getParameterByKey(url, name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec('?'+url.split('?')[1]);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      //get the title and view number of this video using Google API, and add them to the variable videoInfo
      function addVideoData(urlId){
        //TODO: get the data using API

        var key = 'AIzaSyDPUqAa8ZkqTuiYshHqI5L9BjX1WVOuQvk';
        var url = 'https://www.googleapis.com/youtube/v3/videos?id='+urlId+'&key='+key+'&fields=items(id,snippet(channelId,title,categoryId),statistics)&part=snippet,statistics';

        reqwest({
             url: url
           , type: 'json'
           , crossOrigin: true
           , success: function(data){
              var title = data.items[0].snippet.title;
              var view = data.items[0].statistics.viewCount;
              videoInfo.push({title:title, view:view});
              console.log(videoInfo);
              //save  the data, so you can get it later in c3.html
            localStorage.setItem("videoInfo", JSON.stringify(videoInfo));

            console.log(videoInfo);
            loadVideoInfo();

            }
        })
        // p5.loadJSON(url, function(data){
        //   alert('ssss');
        //   console.log(data);
        //     var view = 'put view number here, should be a number'
        //     var title = data.items[0].statistics.viewCount;
        //     videoInfo.push({title:title, view:view});

        // })

        //Google Data API requires a KEY
        //when you get the data, you sould save them into two variables
        // var title = 'put title here'
        // var view = 'put view number here, should be a number'
      }


      //redirect to next page when press enter key
      document.addEventListener("keydown", function(e) {
        if (e.keyCode == 13) { 
          window.location = "c3.html";
        };
      }, false);

    function loadVideoInfo(){

      var info = videoInfo[videoInfo.length-1];
      console.log(videoInfo);
      $('#count').append('<li>'+'Name: '+info.title+'</li>');
      $('#count').append('<li>'+'Views: '+'<b>'+info.view+'</b>'+'</li>'+ '</br>');

      return info;
    }

    </script>
    
  </body>


</html>
