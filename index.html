<!DOCTYPE html>
<html>
<head >
  <title>HelpBigCatsPurr</title>
  <meta charset=utf-8 />
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <!-- javascript order: JQuery, Bootstrap, my js -->
  <script src="js/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.3/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reqwest/1.1.5/reqwest.min.js"></script>
  <script src="js/bootstrap.js"></script>
  <script src="js/jquery.glow.js"></script>
  <!-- CSS -->
  <link type="text/css" rel="stylesheet" href="css/bootstrap.css"/>
  <link href="css/ihover.css" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="css/style.css"/>

</head>

<body>
  <div class="container-fluid">
    <div class="row">
  <!-- page LEFT part -->  
      <div class="col-md-7">
        <div class="gridBlock">
          <div id="catbody"><img src="pics/body.png" class="img-responsive center-block" alt="Responsive image" ></div>
          <a href="#"><img src="pics/paw.gif"  id="playNext" class="img-responsive" alt="Responsive image" onmouseover="this.src='pics/pawglow.png';" onmouseout="this.src='pics/paw.gif';"></a>
          <div  class="embed-responsive center-block embed-responsive-4by3 playerdiv">
            <div id="player"></div>
          </div>
        </div>
      </div> <!-- left col ends -->
   
 <!-- page RIGHT part -->
    <div class="col-md-5">
      <div class="gridBlock">
        <p class="title">HELP BIG CATS PURR</p>
        <p>Collect Rare Cat Species Among Amazing Cat Videos!</p>
        
      <!-- tab -->
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active"><a href="#home" id="tab1" aria-controls="home" role="tab" data-toggle="tab">CATS</a></li>
          <li role="presentation" ><a href="#profile" id="tab2" aria-controls="profile" role="tab" data-toggle="tab">CHEST</a></li>
        </ul>
        
      <!-- tab panel -->
        <div class="tab-content wrap">
          <!-- panel 1 -->
            <div role="tabpanel" class="tab-pane fade in active tabContent1 content" id="home">
              <div id="count"></div>
            </div>
          <!-- panel 2 -->
            <div role="tabpanel" class="tab-pane fade tabContent2 content" id="profile">
              
              <div>
              <h4>You have collected these endangered big cats:</h4>
              <!-- cards -->
                <!-- tiger -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="tiger" class="cardContent">
                    <div><img src="pics/1.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>ENDANGERED</h3>
                      <p>Less than 3000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                <!-- lion -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="lion" class="cardContent">
                    <div><img src="pics/2.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>VULNERABLE</h3>
                      <p>Less than 32000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                <!-- cheetah -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="cheetah" class="cardContent">
                    <div><img src="pics/3.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>VULNERABLE</h3>
                      <p>9000~12000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- Snow Leopard -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="sleopard" class="cardContent">
                    <div><img src="pics/4.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>ENDANGERED</h3>
                      <p>4086~6590</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- Clouded Leopard -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="cleopard" class="cardContent">
                    <div><img src="pics/5.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>VULNERABLE</h3>
                      <p>Less than 10000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- scleopard -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="scleopard" class="cardContent">
                    <div><img src="pics/6.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>VULNERABLE</h3>
                      <p>Less than 10000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- Iberian Lynx -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="lynx" class="cardContent">
                    <div><img src="pics/7.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>CRITICALLY ENDANGERED</h3>
                      <p>84~143</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- Fishing Cat -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="fishingcat" class="cardContent">
                    <div><img src="pics/8.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>ENDANGERED</h3>
                      <p>Less than 10000</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>
                                <!-- Flat-headed Cat -->
                <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                  <div><img src="pics/cardframe.png"></div>
                  <a href="#"><div id="flatheadcat" class="cardContent">
                    <div><img src="pics/9.png" class="img" alt="img"></div>
                    <div class="info">
                      <h3>ENDANGERED</h3>
                      <p>Less than 2500</br>Still Decreasing</p>
                    </div></a>
                  </div>
                </div>

                 <div class="col-xs-6 cardBoarder ih-item square effect6 from_top_and_bottom">
                      <div><img src="pics/cardframe.png" style="opacity: 0;"></div>
                      <h3 id="score"></h3>
                </div>
              </div><!-- cards end -->
              <h3 class="text-center">8/10</h3>
            </div>
        </div>
      </div>
    </div> <!-- right col ends -->


    </div><!-- row ends -->
  </div> <!-- container ends -->



  <script type="text/javascript">

    //*************************** Youtube Initial *****************************//
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      //randomize playlist
      var randomnumber = Math.floor(Math.random() * 11) ;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player'
          , {
            // height: '300px',
            // width: '400px',
            playerVars:{listType: 'playlist',
            list:'PLW1bZqF7FVSN31ILibwTRdYinMq4mx8Vp',
            controls:1,
            autoplay:1,
            index:randomnumber,
            rel: 0,
                    // suggestedQuality:'hd720'
                  },
                  events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                  }
                });        
      }


      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
        saveVideoInfo();

        var playNextBtn = document.getElementById('playNext'); 
        playNextBtn.onclick= function(){
         player.nextVideo();
       }
     }

      // 5. The API calls this function when the player's state changes.
      function onPlayerStateChange(event) {
        //when a video ends(state=0), redirect to next page. Otherwise play next automatically
        if (event.data == YT.PlayerState.ENDED) {
          // redirect to C3
          // window.location = "c3.html";
        }

        //save video info before it starts
        else if ( event.data == YT.PlayerState.UNSTARTED){
          saveVideoInfo();        
        }
      }
      
      function stopVideo() {
        player.stopVideo();
      }
      
    //*********************** IMPORTANT part to get video info **********************
      var videoInfo = [];
      var videoId;
      function saveVideoInfo() {
        var videoUrl = player.getVideoUrl();
        videoId = getParameterByKey(videoUrl, 'v');
        // console.log('video id: '+videoId);

        addVideoData(videoId);
      }


      // parse the url to get the id of a video
      function getParameterByKey(url, name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec('?'+url.split('?')[1]);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      //get the title and view number of this video using Google API, and add them to the variable videoInfo
      function addVideoData(urlId){

        var key = 'AIzaSyDPUqAa8ZkqTuiYshHqI5L9BjX1WVOuQvk';
        var url = 'https://www.googleapis.com/youtube/v3/videos?id='+urlId+'&key='+key+'&fields=items(id,snippet(channelId,title,categoryId),statistics)&part=snippet,statistics';

        reqwest({
         url: url
         , type: 'json'
         , crossOrigin: true
         , success: function(data){
          var title = data.items[0].snippet.title;
          var view = data.items[0].statistics.viewCount;
          videoInfo.push({title:title, view:view});
          // console.log(videoInfo);
              //save  the data, so you can get it later in c3.html
              localStorage.setItem("videoInfo", JSON.stringify(videoInfo));

              // console.log(videoInfo);
              loadVideoInfo();

            }
          })
      }

    //*************************** OUTPUT of video info ***************************
      var bigcat={ 
        // dvxT9evZA9Y: 'tiger', 
        // rq5V9gl5jZw: 'lion',

        XfIl1EibKaM: ['1', 'Tiger','<3,000','tiger'],
        EDg_yHKrRcA: ['2', 'African Lion ↓','<32,000','lion'],
        qqH6V4cfUaY: ['3', 'Cheetah','9,000~12,000','cheetah'],
        EjxvrHDaxKc: ['4', 'Snow Leopard','4,080~6,590','sleopard'],
        ot8q0OUnUwI: ['5', 'Clouded Leopard','<10,000','cleopard'],
        ZiLyDbjEkgw: ['6', 'Sunda Clouded Ledopard','<10,000','scleopard'],
        rv436cpA8vE: ['7', 'Iberian Lynx','84~143','lynx'],
        IjoycRq3r0c: ['8', 'Fishing Cat','<10,000','fishingcat'],
        H4Tt796djv4: ['9', 'Flat-headed Cat','<2,500','flatheadcat']
      }

      
      function loadVideoInfo(){

        var info = videoInfo[videoInfo.length-1];

          if (videoId in bigcat) {
                         
            //append to first tab
            var card = bigcat[videoId];
            console.log(bigcat[videoId]);
            
            var imgNum = card[0];
            var catName = card[1];
            var population = card[2];
            var catId = card[3];

            console.log(imgNum);
            $('#count').prepend('<p class="notice">********** Found Rare Cat Species! *********</p></br>');
            $('#count').prepend('<p class="bigCatName">' + catName +'</br> Estimate Population: '+population+'</p>');        
            $('#count').prepend('<div class="cardgraph"><img class="img-responsive" src="pics/' + imgNum + '.png"></div>');
            $('#count').prepend('<p class="notice">********** Found Rare Cat Species! *********</p>');
            //append to second tab
            document.getElementById(catId).style.display="block";
          }
          else {
            var views = Number(info.view).toLocaleString()
            console.log(views);
            $('#count').prepend($('<p>'+'View Count:  '+'<b class="viewCount">'+views+'</b>'+'</p>'+ '</br>').fadeIn('slow'));
            $('#count').prepend('<p>'+'Name: '+info.title+'</p>');
            return info;
          };
      }


  //************** shortcut to next page: press enter *****************
    window.onload=function() {
        //redirect to next page when press enter key
        document.addEventListener("keydown", function(e) {
          if (e.keyCode == 13) { 
            window.location = "c3.html";
          };
        }, false);
      }
    </script>


  </body>
  </html>